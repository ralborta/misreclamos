// Prisma schema para MisReclamos
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentRole {
  ADMIN
  SUPPORT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum TicketCategory {
  LABORAL
  CIVIL
  COMERCIAL
  PENAL
  FAMILIA
  ADMINISTRATIVO
  TRIBUTARIO
  PREVISIONAL
  OTRO
}

enum TicketChannel {
  WHATSAPP
  EMAIL
  WEB
}

enum MessageDirection {
  INBOUND
  OUTBOUND
  INTERNAL_NOTE
}

enum MessageFrom {
  CUSTOMER
  BOT
  HUMAN
}

enum TicketEventType {
  STATUS_CHANGED
  ASSIGNED
  TAGGED
  PRIORITY_CHANGED
  AUTO_REPLY
  ESCALATED
}

model Customer {
  id          String   @id @default(cuid())
  phone       String   @unique
  name        String?
  // Moderación: si está setado, el bot no envía auto-respuestas para este cliente (agente responde manual)
  botPausedAt DateTime?
  // Información legal
  dni         String?  // DNI o CUIT/CUIL
  email       String?
  address     String?  // Dirección completa
  dateOfBirth DateTime? // Fecha de nacimiento
  notes       String?  // Notas adicionales sobre el cliente
  tickets     Ticket[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([dni])
  @@index([email])
}

model AgentUser {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  phone          String    // Número de teléfono para notificaciones por WhatsApp
  role           AgentRole
  // Información profesional
  matricula      String?   // Matrícula profesional del abogado
  especializacion String?  // Especialización legal (ej: "Derecho Laboral", "Derecho Civil")
  tickets        Ticket[]  @relation("AgentAssignments")
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model Ticket {
  id                String          @id @default(cuid())
  code              String          @unique
  customerId        String
  customer          Customer        @relation(fields: [customerId], references: [id])
  contactName       String          // Nombre de la persona que contacta (ej: "Juan Pérez")
  title             String
  status            TicketStatus
  priority          TicketPriority
  category          TicketCategory
  channel           TicketChannel
  assignedToUserId  String?
  assignedTo        AgentUser?      @relation("AgentAssignments", fields: [assignedToUserId], references: [id])
  lastMessageAt     DateTime        @default(now())
  // AI-generated summaries
  aiSummary         String?         // Resumen de la conversación generado por IA
  resolution        String?         // Conclusión de cómo se resolvió el caso
  resolvedByAI      Boolean         @default(false) // Si fue resuelto automáticamente por IA
  // Información procesal legal
  expedienteNumber  String?         // Número de expediente/juicio
  court             String?         // Juzgado/Tribunal
  legalType         String?         // Tipo específico de caso (ej: "Despido", "Accidente", "Contrato")
  amount            Decimal?        // Monto en disputa (Decimal para precisión)
  importantDates    Json?          // Fechas importantes: { audiencia: Date, vencimiento: Date, etc }
  caseNotes         String?         // Notas internas del abogado sobre el caso
  messages          TicketMessage[]
  events            TicketEvent[]
  tags              TicketTag[]
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([status])
  @@index([priority])
  @@index([customerId])
  @@index([assignedToUserId])
  @@index([lastMessageAt])
  @@index([expedienteNumber])
  @@index([category])
}

model TicketMessage {
  id                String           @id @default(cuid())
  ticketId          String
  ticket            Ticket           @relation(fields: [ticketId], references: [id])
  direction         MessageDirection
  from              MessageFrom
  text              String
  attachments       Json?            // Array de { url, type, name } para imágenes y archivos
  rawPayload        Json
  externalMessageId String?          @unique
  createdAt         DateTime         @default(now())

  @@index([ticketId, createdAt])
}

model TicketEvent {
  id        String           @id @default(cuid())
  ticketId  String
  ticket    Ticket           @relation(fields: [ticketId], references: [id])
  type      TicketEventType
  payload   Json
  createdAt DateTime         @default(now())

  @@index([ticketId, createdAt])
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  tickets   TicketTag[]
  createdAt DateTime    @default(now())
}

model TicketTag {
  ticketId String
  tagId    String
  ticket   Ticket @relation(fields: [ticketId], references: [id])
  tag      Tag    @relation(fields: [tagId], references: [id])

  @@id([ticketId, tagId])
}

// Registros históricos importados desde Excel (carga única / legado)
model Legado {
  id        String   @id @default(cuid())
  data      Json     // Fila completa del Excel (todas las columnas)
  source    String?  // Nombre del archivo origen (ej: "reclamos-2024.xlsx")
  createdAt DateTime @default(now())

  @@index([createdAt])
}

// Tipos de caso (ex prioridades/tipos): altas, bajas y modificaciones desde la UI
model CaseType {
  id        String   @id @default(cuid())
  slug      String   @unique // para URL: accidente-transito
  label     String   // etiqueta en UI: "Accidente de tránsito"
  legalType String   // valor en Ticket.legalType (debe coincidir)
  color     String   @default("slate-500") // clase Tailwind para el indicador (ej: amber-500)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
}
